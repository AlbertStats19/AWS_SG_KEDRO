# 1. Crear los buckets en VS CODE:

aws s3 mb s3://iris-mlops-artifacts --region us-east-1
aws s3 mb s3://iris-mlops-kedro-data --region us-east-1

# 2. Code pipeline conexion git / traer arn en codepipeline YAML

# 3. Ejecución CLOUD FORMATON

Pila1 : MainStack

aws cloudformation deploy `
  --stack-name IrisMLOps-MainStack `
  --template-file infrastructure/main_stack.yaml `
  --capabilities CAPABILITY_NAMED_IAM `
  --parameter-overrides `
    ProjectName=iris-mlops `
    ArtifactsBucketName=iris-mlops-artifacts `
    KedroDataBucketName=iris-mlops-kedro-data `
  --region us-east-1


Pila2: CodePipelineStack

aws cloudformation deploy `
  --stack-name IrisMLOps-CodePipelineStack `
  --template-file infrastructure/codepipeline_stack.yaml `
  --capabilities CAPABILITY_NAMED_IAM `
  --parameter-overrides `
    ProjectName=iris-mlops `
    GitHubConnectionArn="arn:aws:codeconnections:us-east-1:503427799533:connection/9da96d16-3560-4cb3-92ce-2ed3db8ba159" `
    GitHubRepositoryOwner="AlbertStats19" `
    GitHubRepositoryName="AWS_SG_KEDRO" `
    GitHubBranchName="main" `
  --region us-east-1

# 3.5 Agregar roles:  CodePipelineServiceRole
# AdministratorAccess
# AmazonElasticContainerRegistryPublicFullAccess
# AmazonSageMakerFullAccess
# AWSCodeBuildAdminAccess
# AWSCodePipeline_FullAccess

CodeBuildServiceRole:
# AmazonEC2ContainerRegistryPowerUser

# 4. Validar pipeline y registro
aws sagemaker list-pipelines --region us-east-1

# 5. KEDRO DOCKER ECR
aws ecr create-repository --repository-name iris-mlops --region us-east-1 --image-scanning-configuration scanOnPush=true

aws ecr describe-repositories --repository-names iris-mlops --region us-east-1

# 6. Ejecución SAGEMAKER
aws sagemaker start-pipeline-execution --pipeline-name iris-mlops-pipeline-TradeOffBiasVariance --region us-east-1

# 7. Pasos de la Ejecución
aws sagemaker list-pipeline-executions --pipeline-name iris-mlops-pipeline-TradeOffBiasVariance --region us-east-1

aws sagemaker list-pipeline-execution-steps --pipeline-execution-arn arn:aws:sagemaker:us-east-1:503427799533:pipeline/iris-mlops-pipeline-TradeOffBiasVariance/execution/6u4y5nk1ilf5 --region us-east-1

aws sagemaker list-pipeline-execution-steps --pipeline-execution-arn $(aws sagemaker list-pipeline-executions --pipeline-name iris-mlops-pipeline-TradeOffBiasVariance --region us-east-1 --query "PipelineExecutionSummaries[0].PipelineExecutionArn" --output text) --region us-east-1

aws sagemaker describe-processing-job --processing-job-name pipelines-fhv8urhpsw91-TradeOffBiasVariance-oBK3mwh4o3 --region us-east-1

aws logs describe-log-streams --log-group-name /aws/sagemaker/ProcessingJobs --log-stream-name-prefix pipelines-fhv8urhpsw91-TradeOffBiasVariance-oBK3mwh4o3 --region us-east-1

aws logs get-log-events --log-group-name /aws/sagemaker/ProcessingJobs --log-stream-name pipelines-fhv8urhpsw91-TradeOffBiasVariance-oBK3mwh4o3/algo-1-1758753442 --region us-east-1 --limit 100